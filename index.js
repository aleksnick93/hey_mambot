require('dotenv').config()
const fs = require('fs')
const path = require('path')
const { Bot, GrammyError, HttpError, Keyboard, InlineKeyboard, session } = require('grammy')
const sqlite3 = require('sqlite3').verbose()
const { open } = require('sqlite')
const { createTables, getProjects, recordProjectRequest } = require("./db")
const { logger } = require('./utils/logger')
const { updateUserData, recordUserInteraction, isAdmin, createKeyboard, getUsageStats, getMessages } = require('./utils/helpers')

const bot = new Bot(process.env.BOT_API_KEY),
      debugMode = process.env.DEBUG_MODE

bot.use(session({
    initial: () => ({})
}))

let db, projects
(async () => {
    const dbPath = './data/hey_mambot.db'

    const dbExists = fs.existsSync(dbPath)

    db = await open({
        filename: dbPath,
        driver: sqlite3.Database
    })

    if (!dbExists) {
        await createTables(db)
    }

    projects = getProjects(db)

    logger.info('Database initialized and connection established')
})()

bot.command('start', async (ctx) => {
    logger.info(`User ${ctx.from.id} started the bot`)
    await updateUserData(db, ctx.from.id)
    const startKeyboard = new Keyboard()
        .text('üì≤ –¢–∞–ø–∞–ª–∫–∏')
        .row()
        .text('üôã‚Äç‚ôÇÔ∏è –ü—Ä–µ–¥–ª–æ–∂–∫–∞')
        .row()
    await ctx.sendSticker(undefined, ctx.chatId, undefined, 'https://data.chpic.su/stickers/c/cockroach_vk/cockroach_vk_047.webp?v=1693991402')
    await ctx.reply('Buenos dias, amigo! –Ø - –∞–≤—Ç–æ—Ä—Å–∫–∏–π –±–æ—Ç –¥–ª—è —É–ø—Ä–æ—â–µ–Ω–∏—è –∂–∏–∑–Ω–∏ –±—É–¥—É—â–∏—Ö –∫—Ä–∏–ø—Ç–æ–º–∏–ª–ª–∏–æ–Ω–µ—Ä–æ–≤')
    await ctx.sendSticker(undefined, ctx.chatId, undefined, 'https://data.chpic.su/stickers/c/cockroach_vk/cockroach_vk_018.webp?v=1693991402')
    await ctx.reply('üì≤ –¢–∞–ø–∞–ª–∫–∏ - –∫–æ–ª–ª–µ–∫—Ü–∏—è –∫—Ä–∏–ø—Ç–æ–∏–≥—Ä —Å –ª–∏—Å—Ç–∏–Ω–≥–æ–º –∏–ª–∏ —ç–π—Ä–¥—Ä–æ–ø–æ–º')
    await ctx.reply('üôã‚Äç‚ôÇÔ∏è –ü—Ä–µ–¥–ª–æ–∂–∫–∞ - —Ç—É—Ç —Ç—ã –º–æ–∂–µ—à—å –Ω–∞–ø—Ä–∞–≤–∏—Ç—å –º–Ω–µ —Å–æ–æ–±—â–µ–Ω–∏–µ —Å –≤–æ–ø—Ä–æ—Å–æ–º –∏–ª–∏ –ø—Ä–µ–¥–ª–æ–∂–∏—Ç—å –∏–¥–µ–∏ –ø–æ —É–ª—É—á—à–µ–Ω–∏—é —Å–µ—Ä–≤–∏—Å–∞')
    await ctx.reply('üü¢ –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –æ—Ç–ø—Ä–∞–≤–∫—É —Å–æ–æ–±—â–µ–Ω–∏–π, —Ñ–æ—Ç–æ, –≤–∏–¥–µ–æ, –∞—É–¥–∏–æ/–≤–∏–¥–µ–æ—Å–æ–æ–±—â–µ–Ω–∏–π, —Ñ–∞–π–ª–æ–≤')
    await ctx.reply('üëá', {
        reply_markup: startKeyboard,
    })
})

bot.command('admin', async (ctx) => {
    if (!isAdmin(ctx.from.id, process.env.ADMIN_ID)) return

    const stats = await getUsageStats(db)
    let response = `–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞: \n–í—Å–µ–≥–æ –∑–∞–ø—É—Å–∫–æ–≤: ${stats.totalStarts}\n–ó–∞ —Å–µ–≥–æ–¥–Ω—è: ${stats.todayStarts}\n–í–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏–π –≤—Å–µ–≥–æ: ${stats.totalInteractions}\n–ó–∞ —Å–µ–≥–æ–¥–Ω—è: ${stats.todayInteractions}\n\n`

    response += '–ó–∞–ø—Ä–æ—Å—ã –ø–æ —Ç–∞–ø–∞–ª–∫–∞–º:\n'
    for (const { title, total } of stats.totalProjectsRequests) {
        const today = stats.todayProjectsRequests.find(n => n.title === title)?.today || 0
        response += `${title} [${today}/${total}]\n`
    }

    await ctx.reply(response)
})

bot.use(async (ctx, next) => {
    await recordUserInteraction(db, ctx.from.id)
    return next()
})

// function handleButtonClicks(items, recordRequest, type) {
//     items.forEach(item => {
//         bot.hears(item.title, async (ctx) => {
//             if (!isAdmin(ctx.from.id, process.env.ADMIN_ID) || debugMode) {
//                 await recordUserInteraction(db, ctx.from.id)
//                 await recordRequest(db, ctx.from.id, item.id)
//             }
//
//             const projKeyboard = new Keyboard()
//                 .text('üì≤ –¢–∞–ø–∞–ª–∫–∏')
//                 .row()
//                 .text('üôã‚Äç‚ôÇÔ∏è –ü—Ä–µ–¥–ª–æ–∂–∫–∞')
//                 .row()
//             await ctx.reply('–í—ã–±–µ—Ä–∏—Ç–µ –¥–µ–π—Å—Ç–≤–∏–µ:', {
//                 reply_markup: startKeyboard,
//             })
//             let message = ''
//             if (item.type === 'projects') {
//                 message = ``
//             }
//
//
//             // if (item.type === 'social') {
//             //     message = `–í–æ—Ç —Å—Å—ã–ª–∫–∞ –Ω–∞ ${item.name}: ${item.url}`
//             // } else if (item.type === 'promo') {
//             //     message = `–í–æ—Ç —Å—Å—ã–ª–∫–∞ –Ω–∞ ${item.name}: ${item.url}\n\n–ü—Ä–æ–º–æ–∫–æ–¥: ${item.code}\n\n–û–ø–∏—Å–∞–Ω–∏–µ: ${item.description}`
//             // }
//             await ctx.reply(message)
//         })
//     })
// }
//
// handleButtonClicks(projects, recordProjectRequest, 'projects')

bot.hears('üì≤ –¢–∞–ø–∞–ª–∫–∏', async (ctx) => {
    const projectKeyboard = createKeyboard(projects, 'projects')
    await ctx.reply('–ü–æ –∫–Ω–æ–ø–∫–µ –æ—Ç–∫—Ä–æ–µ—Ç—Å—è —Å—Å—ã–ª–∫–∞ –Ω–∞ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ', {
        reply_markup: projectKeyboard,
    })
})

bot.hears('–ù–∞–∑–∞–¥ ‚Ü©Ô∏è', async (ctx) => {
    const startKeyboard = new Keyboard()
        .text('üì≤ –¢–∞–ø–∞–ª–∫–∏')
        .row()
        .text('üôã‚Äç‚ôÇÔ∏è –ü—Ä–µ–¥–ª–æ–∂–∫–∞')
        .row()
    await ctx.reply('–í—ã–±–µ—Ä–∏—Ç–µ –¥–µ–π—Å—Ç–≤–∏–µ:', {
        reply_markup: startKeyboard,
    })
})

let suggestionClicked = {}
let unreadMessagesCount = 0

bot.hears('üôã‚Äç‚ôÇÔ∏è –ü—Ä–µ–¥–ª–æ–∂–∫–∞', async (ctx) => {
    if (isAdmin(ctx.from.id, process.env.ADMIN_ID)) {
        console.log('Admin accessed suggestions')
        const adminKeyboard = new Keyboard()
            .text('–í—Å–µ —Å–æ–æ–±—â–µ–Ω–∏—è')
            .text('‚ùó –ù–µ–æ—Ç–≤–µ—á–µ–Ω–Ω—ã–µ')
            .row()
            .text('–ù–∞–∑–∞–¥ ‚Ü©Ô∏è')
            .row()
        await ctx.reply('–í—ã–±–µ—Ä–∏—Ç–µ', {
            reply_markup: adminKeyboard,
        })
        suggestionClicked[ctx.from.id] = true
    } else {
        suggestionClicked[ctx.from.id] = true
        await ctx.reply('–°–ª—É—à–∞—é –≤–∞—Å –∏ –æ–ø—Ä–∞–≤–ª—é –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –∞–≤—Ç–æ—Ä—É')
    }
})

bot.hears('–í—Å–µ —Å–æ–æ–±—â–µ–Ω–∏—è', async (ctx) => {
    if (!isAdmin(ctx.from.id, process.env.ADMIN_ID)) return
    const messages = await getMessages(db)
    if (messages.length === 0) {
        await ctx.reply('[–ü—É—Å—Ç–æ]')
    } else {
        for (const message of messages) {
            const inlineKeyboard = new InlineKeyboard().text('–û—Ç–≤–µ—Ç–∏—Ç—å', `reply-${message.id}`)
            const userInfo = `–°–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç ${message.first_name} (@${message.username}, ID: ${message.userId})`

            if (message.message) {
                await ctx.reply(`${userInfo}: ${message.message}`, { reply_markup: inlineKeyboard })
            } else {
                const mediaType = message.media_type
                if (mediaType === 'photo') {
                    await ctx.api.sendPhoto(ctx.chat.id, message.media_id, {
                        caption: userInfo,
                        reply_markup: inlineKeyboard
                    })
                } else if (mediaType === 'video') {
                    await ctx.api.sendVideo(ctx.chat.id, message.media_id, {
                        caption: userInfo,
                        reply_markup: inlineKeyboard
                    })
                } else if (mediaType === 'document') {
                    await ctx.api.sendDocument(ctx.chat.id, message.media_id, {
                        caption: userInfo,
                        reply_markup: inlineKeyboard
                    })
                } else if (mediaType === 'audio') {
                    await ctx.api.sendAudio(ctx.chat.id, message.media_id, {
                        caption: userInfo,
                        reply_markup: inlineKeyboard
                    })
                } else if (mediaType === 'voice') {
                    await ctx.api.sendVoice(ctx.chat.id, message.media_id, {
                        caption: userInfo,
                        reply_markup: inlineKeyboard
                    })
                } else if (mediaType === 'video_note') {
                    await ctx.api.sendVideoNote(ctx.chat.id, message.media_id, {
                        caption: userInfo,
                        reply_markup: inlineKeyboard
                    })
                }
            }
        }
    }
})

bot.hears('‚ùó –ù–µ–æ—Ç–≤–µ—á–µ–Ω–Ω—ã–µ', async (ctx) => {
    if (!isAdmin(ctx.from.id, process.env.ADMIN_ID)) return

    const messages = await getMessages(db, 0)

    if (messages.length === 0) {
        await ctx.reply('–ù–æ–≤—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç')
    } else {
        for (const message of messages) {
            const inlineKeyboard = new InlineKeyboard().text('–û—Ç–≤–µ—Ç–∏—Ç—å', `reply-${message.id}`)
            const userInfo = `–°–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç ${message.first_name} (@${message.username}, ID: ${message.userId})`

            if (message.message) {
                await ctx.reply(`${userInfo}: ${message.message}`, { reply_markup: inlineKeyboard })
            } else {
                const mediaType = message.media_type
                if (mediaType === 'photo') {
                    await ctx.api.sendPhoto(ctx.chat.id, message.media_id, {
                        caption: userInfo,
                        reply_markup: inlineKeyboard
                    })
                } else if (mediaType === 'video') {
                    await ctx.api.sendVideo(ctx.chat.id, message.media_id, {
                        caption: userInfo,
                        reply_markup: inlineKeyboard
                    })
                } else if (mediaType === 'document') {
                    await ctx.api.sendDocument(ctx.chat.id, message.media_id, {
                        caption: userInfo,
                        reply_markup: inlineKeyboard
                    })
                } else if (mediaType === 'audio') {
                    await ctx.api.sendAudio(ctx.chat.id, message.media_id, {
                        caption: userInfo,
                        reply_markup: inlineKeyboard
                    })
                } else if (mediaType === 'voice') {
                    await ctx.api.sendVoice(ctx.chat.id, message.media_id, {
                        caption: userInfo,
                        reply_markup: inlineKeyboard
                    })
                } else if (mediaType === 'video_note') {
                    await ctx.api.sendVideoNote(ctx.chat.id, message.media_id, {
                        caption: userInfo,
                        reply_markup: inlineKeyboard
                    })
                }
            }
        }
    }
})

bot.on('message', async (ctx) => {
    const authorId = process.env.ADMIN_ID
    const fromId = ctx.from.id.toString()

    console.log(`unreadMessagesCount: ${unreadMessagesCount}`)
    console.log(`fromId: ${fromId}, authorId: ${authorId}`)

    if (fromId === authorId && ctx.session.replyToUser) {
        const targetMessageId = ctx.session.replyToMessageId

        await db.run(`UPDATE messages SET replied = 1 WHERE id = ?`, [targetMessageId])
        await ctx.api.sendMessage(ctx.session.replyToUser, '–ù–∞ –≤–∞—à–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ª—É—á–µ–Ω –æ—Ç–≤–µ—Ç –æ—Ç –∞–¥–º–∏–Ω–∞ –∫–∞–Ω–∞–ª–∞.')

        if (ctx.message.text) {
            await ctx.api.sendMessage(ctx.session.replyToUser, ctx.message.text)
        } else if (ctx.message.voice) {
            await ctx.api.sendVoice(ctx.session.replyToUser, ctx.message.voice.file_id)
        } else if (ctx.message.video) {
            await ctx.api.sendVideo(ctx.session.replyToUser, ctx.message.video.file_id)
        } else if (ctx.message.photo) {
            const photo = ctx.message.photo.pop()
            await ctx.api.sendPhoto(ctx.session.replyToUser, photo.file_id)
        } else if (ctx.message.audio) {
            await ctx.api.sendAudio(ctx.session.replyToUser, ctx.message.audio.file_id)
        } else if (ctx.message.document) {
            await ctx.api.sendDocument(ctx.session.replyToUser, ctx.message.document.file_id)
        } else if (ctx.message.video_note) {
            await ctx.api.sendVideoNote(ctx.session.replyToUser, ctx.message.video_note.file_id)
        }

        await ctx.reply('–ê–≤—Ç–æ—Ä —Ä–∞—Å—Å–º–æ—Ç—Ä–∏—Ç –≤–∞—à –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π')
        ctx.session.replyToUser = undefined
        ctx.session.replyToMessageId = undefined

        if (unreadMessagesCount > 0) {
            unreadMessagesCount--
        }
        return
    }

    if (suggestionClicked[fromId]) {
        console.log('User sent a suggestion.')
        let mediaType = ''
        let mediaId = ''

        if (ctx.message.text) {
            await db.run(`INSERT INTO messages (user_id, message, first_name, username) VALUES (?, ?, ?, ?)`,
                [ctx.from.id, ctx.message.text, ctx.from.first_name, ctx.from.username])
        } else {
            if (ctx.message.photo) {
                const photo = ctx.message.photo.pop()
                mediaType = 'photo'
                mediaId = photo.file_id
            } else if (ctx.message.video) {
                mediaType = 'video'
                mediaId = ctx.message.video.file_id
            } else if (ctx.message.document) {
                mediaType = 'document'
                mediaId = ctx.message.document.file_id
            } else if (ctx.message.audio) {
                mediaType = 'audio'
                mediaId = ctx.message.audio.file_id
            } else if (ctx.message.voice) {
                mediaType = 'voice'
                mediaId = ctx.message.voice.file_id
            } else if (ctx.message.video_note) {
                mediaType = 'video_note'
                mediaId = ctx.message.video_note.file_id
            }

            await db.run(`INSERT INTO messages (user_id, media_type, media_id, first_name, username) VALUES (?, ?, ?, ?, ?)`,
                [ctx.from.id, mediaType, mediaId, ctx.from.first_name, ctx.from.username])
        }

        await ctx.reply('–í–∞—à–µ —Å–æ–æ–±—â–µ–Ω–∏–µ —É—Å–ø–µ—à–Ω–æ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ –∞–≤—Ç–æ—Ä—É –±–æ—Ç–∞')
        suggestionClicked[fromId] = false

        unreadMessagesCount++
        console.log(`Admin notified, new unreadMessagesCount: ${unreadMessagesCount}`)
        await ctx.api.sendMessage(authorId, `–í–∞–º –ø—Ä–∏—à–ª–æ —Å–æ–æ–±—â–µ–Ω–∏–µ. –ù–µ–æ—Ç–≤–µ—á–µ–Ω–Ω—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π: ${unreadMessagesCount}`)
    } else {
        if (fromId !== authorId) {
            console.log('User is not admin and did not click suggestion.')
            await ctx.reply('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, —Å–Ω–∞—á–∞–ª–∞ –Ω–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É "–ü—Ä–µ–¥–ª–æ–∂–∫–∞" –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏—è –∞–≤—Ç–æ—Ä—É –∫–∞–Ω–∞–ª–∞!')
        } else {
            console.log('Admin received a new message.')
            unreadMessagesCount++
            console.log(`Admin notified, new unreadMessagesCount: ${unreadMessagesCount}`)
            await ctx.api.sendMessage(authorId, `–í–∞–º –ø—Ä–∏—à–ª–æ —Å–æ–æ–±—â–µ–Ω–∏–µ. –ù–µ–æ—Ç–≤–µ—á–µ–Ω–Ω—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π: ${unreadMessagesCount}`)
        }
    }
})

bot.callbackQuery(/^reply-(\d+)$/, async (ctx) => {
    const targetMessageId = ctx.match[1]
    const targetMessage = await db.get('SELECT user_id FROM messages WHERE id = ?', [targetMessageId])

    if (targetMessage) {
        ctx.session.replyToUser = targetMessage.user_id
        ctx.session.replyToMessageId = targetMessageId
        await ctx.answerCallbackQuery('–í—ã –º–æ–∂–µ—Ç–µ –æ—Ç–≤–µ—Ç–∏—Ç—å —Ç–µ–∫—Å—Ç–æ–º, –∞—É–¥–∏–æ, –≤–∏–¥–µ–æ –∏–ª–∏ —Ñ–æ—Ç–æ')
    } else {
        await ctx.answerCallbackQuery('–°–æ–æ–±—â–µ–Ω–∏–µ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ', { show_alert: true })
    }
})

bot.catch((err) => {
    const ctx = err.ctx
    logger.error(`Error while handling update ${ctx.update.update_id}:`, err)
})

bot.start()